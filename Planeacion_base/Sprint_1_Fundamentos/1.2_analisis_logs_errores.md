# Tarea 1.2: An√°lisis de Logs y Errores

## Objetivo
Analizar los logs del sistema (backend y frontend) para identificar errores, warnings, y patrones problem√°ticos que afecten la estabilidad y experiencia del usuario. Esta tarea complementa la evaluaci√≥n de arquitectura con evidencia concreta de issues en runtime.

## Estado Actual
- **Backend log**: `backend.log` contiene logs de FastAPI y LangGraph
- **Frontend log**: `frontend.log` contiene logs de Next.js y React
- **Errores conocidos**:
  - Bug cr√≠tico de respuesta vac√≠a en primera clarificaci√≥n
  - Warnings de Pydantic sobre modelo deprecado
  - Warning sobre m√∫ltiples lockfiles (package-lock.json y pnpm-lock.yaml)
  - Missing translation key "loading"
  - LSP errors en varios archivos backend

### Archivos de Logs
```
- backend.log                              # Logs del servidor FastAPI
- frontend.log                             # Logs del servidor Next.js
- backend/app/api/endpoints.py             # LSP errors detectados
- backend/app/api/user_preferences.py      # LSP errors detectados
- backend/app/api/workflow.py              # LSP errors detectados
- backend/app/agents/graph.py              # LSP errors detectados
- backend/app/agents/workflow_factory.py   # LSP errors detectados
```

## Pasos de Implementaci√≥n

### 1. An√°lisis de Backend Logs
**Objetivo**: Identificar errores y warnings en tiempo de ejecuci√≥n del backend

#### Acciones:
1. **Revisar `backend.log` l√≠nea por l√≠nea**:
   - Buscar patrones de ERROR y WARNING
   - Identificar excepciones no manejadas
   - Buscar stack traces completos
   - Anotar timestamps para correlacionar eventos

2. **Categorizar errores encontrados**:
   - **Cr√≠ticos**: Causan fallo de respuesta o corrupci√≥n de datos
   - **Altos**: Degradan funcionalidad pero sistema sigue corriendo
   - **Medios**: Warnings que podr√≠an convertirse en errores
   - **Bajos**: Logs informativos que indican √°reas de mejora

3. **Analizar Pydantic warnings espec√≠ficos**:
   ```
   PydanticDeprecatedSince20: Support for class-based `config` is deprecated
   ```
   - Identificar todos los modelos afectados
   - Documentar qu√© modelos necesitan migraci√≥n a Pydantic v2
   - Evaluar impacto de no corregir (¬øbreaking change en futuro?)

4. **Revisar logs de LangGraph**:
   - Verificar que todos los nodos se ejecutan correctamente
   - Identificar transiciones fallidas
   - Buscar timeouts o llamadas lentas a LLM

5. **Analizar logs de SSE/streaming**:
   - Verificar que eventos se env√≠an correctamente
   - Buscar conexiones interrumpidas
   - Identificar posibles memory leaks

#### Herramientas recomendadas:
```bash
# Contar errores por tipo
grep -i "error" backend.log | wc -l
grep -i "warning" backend.log | wc -l

# Buscar stack traces
grep -A 10 "Traceback" backend.log

# Buscar errores de Pydantic
grep "Pydantic" backend.log

# Buscar errores de LangGraph
grep "LangGraph\|graph\|node" backend.log
```

### 2. An√°lisis de Frontend Logs
**Objetivo**: Identificar errores y warnings en tiempo de ejecuci√≥n del frontend

#### Acciones:
1. **Revisar `frontend.log` l√≠nea por l√≠nea**:
   - Buscar console.error y console.warn
   - Identificar errores de React (hydration, render, etc.)
   - Buscar errores de red (fetch failed, SSE disconnected)
   - Anotar timestamps para correlacionar con backend

2. **Categorizar errores encontrados**:
   - **Cr√≠ticos**: Rompen UI o impiden interacci√≥n
   - **Altos**: Degradan UX pero funcionalidad existe
   - **Medios**: Warnings de React o Next.js
   - **Bajos**: Logs informativos

3. **Analizar warning de m√∫ltiples lockfiles**:
   ```
   Warning: Multiple lockfiles detected (package-lock.json and pnpm-lock.yaml)
   ```
   - Verificar cu√°l es el package manager correcto
   - Documentar si se debe eliminar uno
   - Evaluar riesgo de inconsistencias en dependencias

4. **Revisar missing translation key**:
   ```
   Missing translation key: loading
   ```
   - Identificar todos los archivos i18n afectados
   - Buscar otras claves faltantes
   - Documentar patr√≥n para evitar en futuro

5. **Analizar errores de SSE en cliente**:
   - Buscar "EventSource error" o "SSE connection failed"
   - Verificar reconexiones autom√°ticas
   - Identificar si hay p√©rdida de mensajes

6. **Revisar errores de TypeScript/ESLint** (si presentes en log):
   - Type errors no capturados en build
   - Warnings de unused variables
   - Deprecated APIs de React o Next.js

#### Herramientas recomendadas:
```bash
# Contar errores por tipo
grep -i "error" frontend.log | wc -l
grep -i "warning" frontend.log | wc -l

# Buscar errores de React
grep "React\|Hydration\|render" frontend.log

# Buscar errores de red
grep "fetch\|SSE\|EventSource" frontend.log

# Buscar missing translations
grep "Missing translation" frontend.log
```

### 3. An√°lisis de LSP Errors (Type Checking)
**Objetivo**: Documentar y categorizar errores de tipado est√°tico

#### Errores Identificados por Archivo:

**`backend/app/api/endpoints.py`** (30+ errors):
- Problemas con tipos de SQLAlchemy `Column[T]` vs tipos Python `T`
- Acceso a atributos inexistentes en clases custom
- Expresiones `None` asignadas a par√°metros `str`

**`backend/app/api/user_preferences.py`** (6 errors):
- Tipos `Column[str]` no asignables a `str`
- Problemas similares a endpoints.py

**`backend/app/api/workflow.py`** (3 errors):
- Tipos incompatibles en par√°metros de funci√≥n
- Problemas con async iterables

**`backend/app/agents/graph.py`** (2 errors):
- Variables en type expressions (Literal)

**`backend/app/agents/workflow_factory.py`** (3 errors):
- Imports no resueltos para graphs de prompts

#### Acciones:
1. **Para cada archivo con errores**:
   - Leer el archivo completo
   - Entender el contexto de cada error
   - Clasificar seg√∫n severidad:
     - **Cr√≠tico**: Error real que puede causar runtime failure
     - **Falso positivo**: Mypy/Pyright malinterpreta c√≥digo correcto
     - **Cosm√©tico**: Type hint incorrecto pero funciona

2. **Documentar soluciones potenciales**:
   - Para errores de SQLAlchemy: usar `type: ignore` o actualizar hints
   - Para imports no resueltos: verificar si archivos existen o crear stubs
   - Para problemas de Literal: revisar sintaxis correcta

3. **Evaluar si configurar Mypy/Pyright**:
   - ¬øHay configuraci√≥n actual en `pyproject.toml`?
   - ¬øSe debe habilitar type checking en CI/CD?
   - ¬øQu√© nivel de strictness es apropiado?

### 4. Correlaci√≥n de Errores Backend-Frontend
**Objetivo**: Identificar errores que cruzan capas del sistema

#### Acciones:
1. **Mapear bug de respuesta vac√≠a**:
   - Encontrar en backend.log cuando se genera clarificaci√≥n
   - Encontrar en frontend.log cuando se recibe mensaje vac√≠o
   - Correlacionar timestamps
   - Identificar d√≥nde se pierde el dato

2. **Buscar otros errores correlacionados**:
   - Errores de API que causen errores en frontend
   - Timeouts del backend reflejados en frontend
   - Errores de validaci√≥n propagados incorrectamente

3. **Documentar flujos problem√°ticos completos**:
   - Input usuario ‚Üí Processing ‚Üí Output
   - Identificar cada punto donde puede fallar
   - Proponer mejoras en error handling

### 5. An√°lisis de Patrones y Tendencias
**Objetivo**: Identificar problemas sist√©micos, no solo errores puntuales

#### Acciones:
1. **Buscar patrones de errores recurrentes**:
   - Mismo error aparece m√∫ltiples veces
   - Errores que ocurren en secuencia predecible
   - Errores que solo pasan bajo ciertas condiciones

2. **Analizar frecuencia temporal**:
   - ¬øErrores ocurren al inicio, durante uso, o al cerrar?
   - ¬øHay errores que solo pasan despu√©s de X tiempo de uptime?
   - ¬øHay memory leaks indicados por degradaci√≥n gradual?

3. **Identificar √°reas del c√≥digo m√°s problem√°ticas**:
   - ¬øQu√© m√≥dulos generan m√°s errores?
   - ¬øQu√© features son m√°s inestables?
   - ¬øHay c√≥digo legacy sin tests que falla frecuentemente?

### 6. Documentar Hallazgos y Recomendaciones
**Objetivo**: Crear reporte estructurado para guiar correcciones

#### Acciones:
1. **Crear tabla de errores por prioridad**:
   ```markdown
   | Prioridad | Error | Archivo(s) | Impacto | Soluci√≥n Propuesta |
   |-----------|-------|------------|---------|-------------------|
   | CR√çTICA   | ...   | ...        | ...     | ...               |
   ```

2. **Documentar cada error con**:
   - Descripci√≥n clara del problema
   - Ubicaci√≥n exacta (archivo, l√≠nea si aplica)
   - C√≥mo reproducir
   - Stack trace o log relevante
   - Impacto en usuario/sistema
   - Soluci√≥n propuesta con pasos concretos

3. **Generar m√©tricas de calidad**:
   - Total de errores por categor√≠a (cr√≠tico/alto/medio/bajo)
   - Cobertura de logs (¬øhay suficiente logging?)
   - Calidad de mensajes de error (¬øson √∫tiles para debugging?)

4. **Proponer mejoras de logging**:
   - √Åreas que necesitan m√°s logs
   - Formato de logs (¬øusar structured logging?)
   - Niveles de log apropiados
   - Herramientas de monitoreo (Sentry, LogRocket, etc.)

## Consideraciones Importantes

### Seguridad en Logs
- ‚ö†Ô∏è **CR√çTICO**: Verificar que NO se logueen API keys, tokens, o datos sensibles
- Revisar que logs de producci√≥n no expongan informaci√≥n de usuarios
- Verificar que stack traces no revelen rutas del sistema

### Performance de Logging
- Evaluar si logging excesivo afecta performance
- Considerar async logging para operaciones pesadas
- Verificar rotaci√≥n de logs (¬øarchivos crecen indefinidamente?)

### Monitoreo Proactivo
- Evaluar si se necesita alerting autom√°tico para errores cr√≠ticos
- Considerar integraci√≥n con herramientas como Sentry
- Proponer dashboards de health del sistema

## Preguntas Clave

1. **¬øLos logs actuales son suficientes para debugging?**
   - ¬øHay suficiente contexto en cada log?
   - ¬øSe loguean IDs de requests para correlacionar?

2. **¬øSe deben usar herramientas de APM (Application Performance Monitoring)?**
   - Sentry para error tracking
   - LogRocket para session replay
   - Datadog/New Relic para m√©tricas

3. **¬øCu√°l es la estrategia de logs para producci√≥n vs desarrollo?**
   - ¬øDiferentes niveles de verbosidad?
   - ¬øDiferentes destinos (file, stdout, servicio externo)?

4. **¬øLos LSP errors son bloqueantes?**
   - ¬øSe debe configurar CI para fallar en type errors?
   - ¬øCu√°l es el nivel de strictness apropiado?

5. **¬øHay errores silenciosos (swallowed exceptions)?**
   - Try/except sin logging
   - Promesas rechazadas sin .catch()

6. **¬øEl sistema tiene health checks adecuados?**
   - ¬øEndpoints de /health, /readiness, /liveness?
   - ¬øVerifican conectividad a DB, APIs externas?

## Criterios de √âxito

- [ ] An√°lisis completo de `backend.log` documentado
- [ ] An√°lisis completo de `frontend.log` documentado
- [ ] Todos los LSP errors categorizados por severidad
- [ ] Tabla de errores priorizada creada
- [ ] Errores correlacionados backend-frontend identificados
- [ ] Patrones de errores recurrentes documentados
- [ ] Reporte de hallazgos completo con m√©tricas
- [ ] Recomendaciones de mejoras de logging propuestas
- [ ] Plan de acci√≥n para corregir errores cr√≠ticos
- [ ] Verificaci√≥n de seguridad en logs completada

## Resultado Esperado
Un reporte detallado que incluya:
1. **Inventario completo de errores** con priorizaci√≥n
2. **Root cause analysis** de errores cr√≠ticos
3. **Recomendaciones** de correcci√≥n con pasos espec√≠ficos
4. **Mejoras propuestas** al sistema de logging
5. **Plan de acci√≥n** para Tarea 1.3 (fix de bug cr√≠tico)

## Notas Importantes

‚ö†Ô∏è **IMPORTANTE**: Al completar esta tarea, actualizar el archivo `PROGRESS.md` marcando la tarea 1.2 como completada.

üìù **Documentaci√≥n**: Guardar el reporte de an√°lisis en `Sprint_1_Fundamentos/analisis_logs_errores_reporte.md`

üîç **Enfoque**: Esta tarea es 100% an√°lisis, no hacer cambios de c√≥digo. Los fixes se har√°n en tareas 1.3, 1.4, y 1.5.

üîó **Relaci√≥n con otras tareas**: 
- Los hallazgos de esta tarea alimentan directamente la Tarea 1.3 (bug cr√≠tico)
- Complementa la Tarea 1.1 (evaluaci√≥n de arquitectura) con evidencia concreta
- Identifica issues para Tarea 1.5 (mejoras UX b√°sicas)
